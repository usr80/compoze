doctype
html(lang="zh-CN")
  head
    meta(charset="utf-8")
    title composer
    meta(name="viewport",content="width=device-width, initial-scale=1")
    link(rel="stylesheet",href="../style/base.css")
    link(rel="stylesheet",href="../style/font.css")

    link(rel="stylesheet",href="../../script/codemirror/lib/codemirror.css")
    script(src="../../script/codemirror/lib/codemirror.js")
    script(src="../../script/codemirror/mode/javascript/javascript.js")

    style.
      .CodeMirror {
          line-height: 1;
          position: absolute;
          overflow: hidden;
          background: white;
          color: black;
          top: 0;
          width: 100%;
          font-size: 12px;
        }
  body

    div#start.start.icon &#xe602;
    div#stop.stop.icon.hidden &#xe601;
    div(style="text-align:center")
      h2 Komm,s√ºsser Tod
    .container(style="width:100%;margin: 0 auto; ")
      div(style="display:table-cell;width:50%;position:relative;")
        textarea#editor.
          options player=true tempo=90 tab-stems=true width=980
          tabstave notation=false tablature=true
            notes :8 (0/5.0/4.6/3.5/2.7/1) 6/3 :q (5/2.7/1) :8 (0/5.0/4.6/3.6/2.7/1) 6/3 :q (6/2.7/1)|
            notes :16 (0/5.0/4.7/3.7/2.7/1) 9/1 :8 7/3 :q (7/2.9/1) :8 (0/5.0/4.0/3.6/2.7/1) 7/3 :4 (6/2.7/1)|
          tabstave
              notes :8 (0/5.0/4.6/3.5/2.7/1) 6/3 :q (5/2.7/1) :8 (0/5.0/4.6/3.6/2.7/1) 6/3 :q (6/2.7/1)|
            notes :16 (0/5.0/4.7/3.7/2.7/1) 9/1 :8 7/3 :q (7/2.9/1) :8 (0/5.0/4.0/3.6/2.7/1) 7/3 :4 (6/2.7/1)

          tabstave
            notes :8 (0/5.0/1) :16 2/4 2/4 (0/1.2/3.0/5) 0/2 0/2 ^3^ :8 (1/1.3/2.0/5) :16 2/2 2/2 (1/1.0/2.0/5) :8 2/4 |
            notes :4 (2/3.3/4.0/5) :16 (0/1.4/4.0/5) 3/2 2/3 3/2 0/5 3/4 3/2 0/1 3/2 2/3 :8 3/4 |

          tabstave
            notes :8 (0/1.0/5) :16 2/4 2/4 (0/1.2/3.2/5) 0/2 0/2 ^3^ :8 (1/1.3/2.0/5) :16 2/2 2/2 (1/1.0/2.0/5) 3/4 :8 3/4 |
            notes :8 0/5 :16 4/4 2/4 (0/1.0/5) 3/2 2/3 3/2 0/5 3/4 3/2 0/1 3/2 2/3 :8 0/4
      div(style="display:table-cell;position:relative;width:50%")
        #player(style="display:none").
          options player=true tempo=90 tab-stems=true width=980
          tabstave notation=false tablature=true
            notes :8 (0/5.0/4.6/3.5/2.7/1) 6/3 :q (5/2.7/1) :8 (0/5.0/4.6/3.6/2.7/1) 6/3 :q (6/2.7/1)|
            notes :16 (0/5.0/4.7/3.7/2.7/1) 9/1 :8 7/3 :q (7/2.9/1) :8 (0/5.0/4.0/3.6/2.7/1) 7/3 :4 (6/2.7/1)|
          tabstave
              notes :8 (0/5.0/4.6/3.5/2.7/1) 6/3 :q (5/2.7/1) :8 (0/5.0/4.6/3.6/2.7/1) 6/3 :q (6/2.7/1)|
            notes :16 (0/5.0/4.7/3.7/2.7/1) 9/1 :8 7/3 :q (7/2.9/1) :8 (0/5.0/4.0/3.6/2.7/1) 7/3 :4 (6/2.7/1)

          tabstave
            notes :8 (0/5.0/1) :16 2/4 2/4 (0/1.2/3.0/5) 0/2 0/2 ^3^ :8 (1/1.3/2.0/5) :16 2/2 2/2 (1/1.0/2.0/5) :8 2/4 |
            notes :4 (2/3.3/4.0/5) :16 (0/1.4/4.0/5) 3/2 2/3 3/2 0/5 3/4 3/2 0/1 3/2 2/3 :8 3/4 |

          tabstave
            notes :8 (0/1.0/5) :16 2/4 2/4 (0/1.2/3.2/5) 0/2 0/2 ^3^ :8 (1/1.3/2.0/5) :16 2/2 2/2 (1/1.0/2.0/5) 3/4 :8 3/4 |
            notes :8 0/5 :16 4/4 2/4 (0/1.0/5) 3/2 2/3 3/2 0/5 3/4 3/2 0/1 3/2 2/3 :8 0/4



    .loading.line-scale
      div
      div
      div
      div
      div

    script(src="../../composer.js")
    script(src="../../script/MIDI/MIDI.min.js")
    script(src="../../script/inc/Base64.js")
    script(src="../../script/inc/base64binary.js")
    script.
      document.getElementById('player').innerHTML = document.getElementById('player').innerHTML.replace(/width=\d+/g, 'width='+window.innerWidth/2)
      instance = new Vex.Flow.TabDiv(document.getElementById('player'),
          {
              instrument: 'acoustic_guitar_steel',
              soundfont_url: "http://yuepuso.qiniudn.com/"
          }
      );
      document.getElementById('player').style.display = 'block'

      window.myCodeMirror = CodeMirror.fromTextArea($('#editor')[0], {
        lineNumbers: true,
        mode: "javascript",
        lineWrapping: true,
        fixedGutter:false
        });
      myCodeMirror.on('change',function(){
        setTimeout(function(){
          myCodeMirror.setSize(myCodeMirror.getScrollInfo().clientWidth, myCodeMirror.getScrollInfo().height)
        },200)
        if(instance.timeoutID) clearTimeout(instance.timeoutID)
        if(instance.code !== myCodeMirror.getValue().replace(/width=\d+/g, 'width='+window.innerWidth/2)){
          instance.timeoutID = setTimeout( function(){
            instance.code = myCodeMirror.getValue().replace(/width=\d+/g, 'width='+window.innerWidth/2);
            instance.redraw()
          }, 250);
        }
      });

      $('#start').on('click',function(){
        instance.player.play()
        $('#stop').show()
        $('#start').hide()
      })
      $('#stop').on('click',function(){
        instance.player.stop()
        $('#start').show()
        $('#stop').hide()
      })